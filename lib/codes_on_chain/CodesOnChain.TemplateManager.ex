defmodule CodesOnChain.SoulCard.TemplateManager do
  @moduledoc """
    TemplateManager
  """
  require Logger
  alias Components.{KVHandler, Verifier, ModuleHandler, MsgHandler}

  def get_module_doc(), do: @moduledoc


  # TODO: only allow admin to do this later.
  def put(template_base64_encoded, addr, msg, signature) do
    with true <- Verifier.verify_message?(addr, msg, signature),
    true <- MsgHandler.time_valid?(msg)do
      templates =
        get()
        |> handle_kv_value()
      id_now = Enum.count(templates)
      templates = templates ++ [template_base64_encoded]
      {:ok, _} = KVHandler.put("templates", templates, ModuleHandler.get_module_name(__MODULE__))
      {:ok, %{id: id_now}}
    else
      error ->
        {:error, inspect(error)}
    end
  end

  def handle_kv_value(nil), do: []
  def handle_kv_value(others), do: others

  def init()  do
    if is_nil(get()) do
      KVHandler.put("templates", [], ModuleHandler.get_module_name(__MODULE__))
    end
  end

  @doc """
  Get all templates
  """
  def get(), do: KVHandler.get("templates", ModuleHandler.get_module_name(__MODULE__))

  def get_by_id(id) do
    templates =
        get()
        |> handle_kv_value()
    id_handled = handle_id(id)
    Enum.at(templates, id_handled)
  end

  def handle_id(id) when is_binary(id) do
    String.to_integer(id)
  end

  def handle_id(id), do: id

  def init_templates() do
    templates = ["PCFET0NUWVBFIGh0bWw+CjxodG1sIGxhbmc9ImVuIj4KPGhlYWQ+CiAgICA8bWV0YSBjaGFyc2V0PSJVVEYtOCI+CiAgICA8bWV0YSBodHRwLWVxdWl2PSJYLVVBLUNvbXBhdGlibGUiIGNvbnRlbnQ9IklFPWVkZ2UiPgogICAgPG1ldGEgbmFtZT0idmlld3BvcnQiIGNvbnRlbnQ9IndpZHRoPWRldmljZS13aWR0aCwgaW5pdGlhbC1zY2FsZT0xLjAiPgogICAgPHRpdGxlPkRvY3VtZW50PC90aXRsZT4KPC9oZWFkPgo8c3R5bGUgdHlwZT0idGV4dC9jc3MiPgojYXBwIHsKICAgIGJhY2tncm91bmQtY29sb3I6IGJsYWNrOwp9Ci5wLTQgewogIHBhZGRpbmc6IDRweDsKfQoucC04IHsKICBwYWRkaW5nOiA4cHg7Cn0KLnRleHQtd2hpdGUgewogIGNvbG9yOiB3aGl0ZTsKfQoudGV4dC1ibHVyLXdoaXRlIHsKICBjb2xvcjogcmdiYSgyNTUsIDI1NSwgMjU1LCAwLjcpCn0KLnRleHQtZ3JheSB7CiAgY29sb3I6ICNDNUM1QzU7Cn0KLnRleHQtcmlnaHQgewogIHRleHQtYWxpZ246IHJpZ2h0Owp9Ci5mdC1zLTEwIHsKICBmb250LXNpemU6IDEwcHg7Cn0KLmZ0LXMtMTIgewogIGZvbnQtc2l6ZTogMTJweDsKfQouZnQtcy0xNCB7CiAgZm9udC1zaXplOiAxNHB4Owp9Ci5mdC1zLTE2IHsKICBmb250LXNpemU6IDE2cHg7Cn0KLmZ0LXMtMjQgewogIGZvbnQtc2l6ZTogMjRweDsKfQouZnQtcy02NCB7CiAgZm9udC1zaXplOiA2NHB4Owp9Ci5mdy03MDAgewogIGZvbnQtd2VpZ2h0OiA3MDA7Cn0KLmZsZXggewogIGRpc3BsYXk6IGZsZXg7Cn0KLmdyaWQgewogIGRpc3BsYXk6IGdyaWQ7Cn0KLmFkZHJlc3MgewogIHBhZGRpbmc6IDAgNHB4Owp9Ci5iZy1ncmV5IHsKICBiYWNrZ3JvdW5kLWNvbG9yOiBncmV5Owp9Ci5iZy13aGl0ZSB7CiAgYmFja2dyb3VuZC1jb2xvcjogd2hpdGU7Cn0KLmdlbmVyYWwtYm9yZGVyIHsKICBib3JkZXI6IC41cHggc29saWQgI0ZGRkZGRjsKICBib3JkZXItcmFkaXVzOiA0cHg7Cn0KLmJvcmRlci10IHsKICBib3JkZXItdG9wOiAuNXB4IHNvbGlkICNGRkZGRkY7Cn0KLmJvcmRlci1iIHsKICBib3JkZXItYm90dG9tOiAuNXB4IHNvbGlkICNGRkZGRkY7Cn0KLnBvaW50ZXIgewogIGN1cnNvcjogcG9pbnRlcjsKfQoubGluZS1oZWlnaHQtb25lIHsKICBsaW5lLWhlaWdodDogMTsKfQoud29yZC1icmVhayB7CiAgd2hpdGUtc3BhY2U6IG5vd3JhcDsKICB3b3JkLWJyZWFrOiBrZWVwLWFsbDsKICBvdmVyZmxvdzogaGlkZGVuOwogIHRleHQtb3ZlcmZsb3c6IGVsbGlwc2lzOwp9Ci5yZWxhdGl2ZSB7CiAgcG9zaXRpb246IHJlbGF0aXZlOwp9Ci5hYnNvbHV0ZSB7CiAgcG9zaXRpb246IGFic29sdXRlOwp9Ci5iZy1ncmEgewogIGJhY2tncm91bmQ6IHJnYmEoMjAsIDY3LCA3OCwgMC4zKTsKfQouY2FyZC1wYWRkaW5nIHsKICAgIHBhZGRpbmc6IDU0cHggNzRweDsKICAgIHdpZHRoOiAzMzZweDsKfQouc3ViLWhlYWRlciB7CiAgICBncmlkLXRlbXBsYXRlLWNvbHVtbnM6IDFmciAxZnI7Cn0KLmJhc2ljLWluZm8gewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgei1pbmRleDogMjsKICAgIHRvcDogMDsKICAgIGxlZnQ6IDA7CiAgICB3aWR0aDogMjMwcHg7CiAgICBoZWlnaHQ6IDEzNXB4Owp9Ci5pbnRybyB7CiAgICBsaW5lLWhlaWdodDogMS4yOwogICAgbWFyZ2luLXRvcDogNXB4OwogICAgcGFkZGluZzogOHB4Owp9Ci5hZGRyIHsKICAgIGRpc3BsYXk6IGlubGluZS1ibG9jazsKICAgIHdpZHRoOiAxMDAlOwogICAgd2hpdGUtc3BhY2U6IG5vd3JhcDsKICAgIHdvcmQtYnJlYWs6IGtlZXAtYWxsOwogICAgb3ZlcmZsb3c6IGhpZGRlbjsKICAgIHRleHQtb3ZlcmZsb3c6IGVsbGlwc2lzOwogICAgbWFyZ2luLWxlZnQ6IDEwcHg7CiAgICBwYWRkaW5nLWxlZnQ6IDVweDsKfQoubG9jYXRpb24gewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgbGVmdDogMjQwcHg7CiAgICB0b3A6IDA7CiAgICB3aWR0aDogOTVweDsKICAgIGhlaWdodDogOTVweDsKfQoubGlzdC1pdGVtIHsKICAgIGRpc3BsYXk6IGlubGluZS1ibG9jazsKICAgIHBhZGRpbmc6IDRweCA4cHg7CiAgICBjb2xvcjogYmxhY2s7CiAgICBtYXJnaW4tcmlnaHQ6IDVweDsKICAgIG1hcmdpbi1ib3R0b206IDVweDsKfQouY29udGFjdC1pdGVtIHsKICAgIG1hcmdpbi10b3A6IDIwcHg7CiAgICBtYXJnaW4tbGVmdDogMTBweDsKfQouc2tpbGxzLWxpc3QgewogICAgd2lkdGg6IDEwMCU7CiAgICBoZWlnaHQ6IDkwcHg7CiAgICBvdmVyZmxvdy15OiBzY3JvbGw7CiAgICBwYWRkaW5nLWxlZnQ6IDhweDsKfQouc2tpbGxzIHsKICAgIHdpZHRoOiAxOThweDsKICAgIGhlaWdodDogMTMwcHg7CiAgICB0b3A6IDE0MHB4OwogICAgbGVmdDogMDsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKfQouYXZhdGFyIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHJpZ2h0OiAwOwogICAgdG9wOiAxMDNweDsKICAgIHdpZHRoOiAxMzBweDsKICAgIGhlaWdodDogMjMzcHg7CiAgICB6LWluZGV4OiAwOwp9Ci5hdmF0YXIgaW1nIHsKICBtYXgtd2lkdGg6IDEwMCU7CiAgbWF4LWhlaWdodDogMTAwJTsKICBvYmplY3QtZml0OiBjb3ZlcjsKfQouY29udGFjdCB7CiAgICB3aWR0aDogMTk4cHg7CiAgICBoZWlnaHQ6IDYxcHg7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDI3NXB4OwogICAgbGVmdDogMDsKfQouaW5zaWRlIHsKICAgIHBvc2l0aW9uOiByZWxhdGl2ZTsKICAgIGhlaWdodDogMzM2cHg7CiAgICB3aWR0aDogMzM2cHg7Cn0KLmF3c29tZS10aGluZ3MgewogICAgbWFyZ2luLXRvcDogOHB4Owp9Ci5hd3NvbWUtdGhpbmdzLXRpdGxlIHsKICAgIHBhZGRpbmc6IDRweCA4cHg7Cn0KLmNpcmNsZS1idXR0b24gewogICAgZmxleDogMTsKICAgIHRleHQtYWxpZ246IHJpZ2h0Owp9Ci5kYW8tbGlzdCB7CiAgICBoZWlnaHQ6IDI1MHB4OwogICAgb3ZlcmZsb3cteTogc2Nyb2xsOwp9Ci5wb3NpdGlvbiB7CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwp9Ci5wcm9qZWN0LWl0ZW0gewogICAgdGV4dC1kZWNvcmF0aW9uOiB1bmRlcmxpbmU7CiAgICBkaXNwbGF5OiBpbmxpbmUtYmxvY2s7CiAgICBtYXJnaW4tcmlnaHQ6IDhweDsKICAgIG1hcmdpbi1ib3R0b206IDRweDsKfQoucG9pbnRlciB7CiAgY3Vyc29yOiBwb2ludGVyOwp9Ci5jYXJkLWNvbnRhaW5lciB7Cgp9Ci5jLWljb24gewogICAgYmFja2dyb3VuZC1jb2xvcjogI0M1RUY4MzsKICAgIHdpZHRoOiAxNnB4OwogICAgaGVpZ2h0OiAxNnB4OwogICAganVzdGlmeS1jb250ZW50OiBjZW50ZXI7CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgYm9yZGVyLXJhZGl1czogNHB4Owp9Ci5vcHRpb25zIHsKICAgIGNvbG9yOiB3aGl0ZTsKICAgIGJveC1zaGFkb3c6IDBweCA0cHggMTJweCByZ2JhKDAsIDAsIDAsIDAuNSk7CiAgICBwYWRkaW5nOiA1cHggMzNweDsKICAgIGJvcmRlci1yYWRpdXM6IDZweDsKfQoucG9wb3ZlciB7CiAgICBiYWNrZ3JvdW5kLWNvbG9yOiByZ2JhKDUxLCA1MSwgNTEsIDAuODUpOwogICAgYm94LXNoYWRvdzogNHB4IDRweCAxMHB4IHJnYmEoMCwgMCwgMCwgMC4xKTsKICAgIGJvcmRlci1yYWRpdXM6IDRweDsKICAgIGJvcmRlci1yYWRpdXM6IDRweDsKICAgIHJpZ2h0OiAtNDBweDsKICAgIHRvcDogMzBweDsKICAgIHotaW5kZXg6IDQ7CiAgfQoub3B0aW9uczpob3ZlciB7CiAgICBjb2xvcjogYmxhY2s7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoOTIuNWRlZywgIzc5RDVBOCAzLjc2JSwgI0Q1Rjk3RCA5OC45NyUpOwp9Ci5kYW8taXRlbSB7CiAgcGFkZGluZy10b3A6IDRweDsKICBwYWRkaW5nLWxlZnQ6IDRweDsKICBhbGlnbi1pdGVtczogY2VudGVyOwp9Ci5kYW8tbmFtZSB7Cgp9CiAgLmluc2lkZS1jb250YWluZXIgewogICAgICBoZWlnaHQ6IDEwMCU7CiAgfQo8L3N0eWxlPgo8Ym9keT4KICAgIDxzY3JpcHQgc3JjPSJodHRwczovL3VucGtnLmNvbS92dWVAMy9kaXN0L3Z1ZS5nbG9iYWwuanMiPjwvc2NyaXB0PgogICAgPGRpdiBpZD0iYXBwIj4KICAgICAgICA8ZGl2IGNsYXNzPSJjYXJkLXBhZGRpbmcgdGV4dC13aGl0ZSI+CiAgICAgICAgICAgIDxkaXYgY2xhc3M9Imluc2lkZSB0ZXh0LWlibSI+CiAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iYmFzaWMtaW5mbyBnZW5lcmFsLWJvcmRlciI+CiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJmdC1zLTI0IHRleHQtaWJtLWJvbGQgcC04Ij57eyBjYXJkRGF0YS5iYXNpY19pbmZvLm5hbWUgfX08L2Rpdj4KICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImZsZXggYWRkcmVzcyI+CiAgICAgICAgICAgICAgICAgIDxpbWcgY2xhc3M9IiIgc3JjPSJodHRwczovL3NvdWxjYXJkLm5vbmNlZ2Vlay5jb20vc291bGNhcmRfaWNvbi9hZGRyZXNzLnN2ZyIgYWx0PSIiIC8+CiAgICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJtbC1bMTBweF0gZnQtcy0xNCBiZy1ncmV5IHRleHQtZ3JheSBhZGRyIj4KICAgICAgICAgICAgICAgICAgICB7e2NhcmREYXRhLmFkZHJ9fQogICAgICAgICAgICAgICAgICA8L3NwYW4+CiAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImludHJvIG10LVs1cHhdIHRleHQtYmx1ci13aGl0ZSI+CiAgICAgICAgICAgICAgICAgIHt7Y2FyZERhdGEuYmFzaWNfaW5mby5zbG9nYW59fQogICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgPGRpdiBjbGFzcz0ibG9jYXRpb24gZ2VuZXJhbC1ib3JkZXIiPgogICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0icC00Ij4KICAgICAgICAgICAgICAgICAgPGltZyBzcmM9Imh0dHBzOi8vc291bGNhcmQubm9uY2VnZWVrLmNvbS9zb3VsY2FyZF9pY29uL2xvY2F0aW9uLnN2ZyIgYWx0PSIiIC8+CiAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9InAtNCI+e3tjYXJkRGF0YS5iYXNpY19pbmZvLmxvY2F0aW9ufX08L2Rpdj4KICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJza2lsbHMgZ2VuZXJhbC1ib3JkZXIiPgogICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iZnQtcy0xNiB0ZXh0LWlibS1ib2xkIHAtOCI+U2tpbGxzPC9kaXY+CiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJza2lsbHMtbGlzdCI+CiAgICAgICAgICAgICAgICAgICAgPGRpdiAKICAgICAgICAgICAgICAgICAgICAgICAgY2xhc3M9Imxpc3QtaXRlbSBiZy13aGl0ZSBtci1bNXB4XSBmdC1zLTEwIG1iLVs1cHhdIGdlbmVyYWwtYm9yZGVyIiAKICAgICAgICAgICAgICAgICAgICAgICAgdi1mb3I9IihpdGVtLCBpbmRleCkgaW4gY2FyZERhdGEuYmFzaWNfaW5mby5za2lsbHMiIAogICAgICAgICAgICAgICAgICAgICAgICA6a2V5PSJpbmRleCI+CiAgICAgICAgICAgICAgICAgICAgICAgIHt7aXRlbX19CiAgICAgICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJhdmF0YXIgZ2VuZXJhbC1ib3JkZXIgZmxleCBqdXN0aWZ5LWNlbnRlciBpdGVtcy1jZW50ZXIiPgogICAgICAgICAgICAgICAgPGltZyBjbGFzcz0nbWF4LXctZnVsbCBtYXgtaC1mdWxsJyA6c3JjPSJjYXJkRGF0YS5iYXNpY19pbmZvLmF2YXRhciA/IGNhcmREYXRhLmJhc2ljX2luZm8uYXZhdGFyIDogYXZhdGFyIiBhbHQ9IiIgLz4KICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJjb250YWN0IGdlbmVyYWwtYm9yZGVyIj4KICAgICAgICAgICAgICAgIDxpbWcgQGNsaWNrPSJjb250Y2F0Q2xpY2soZmFsc2UsIGNhcmREYXRhLmJhc2ljX2luZm8uc29jaWFsX2xpbmtzLmRpc2NvcmQpIiBjbGFzcz0icG9pbnRlciBjb250YWN0LWl0ZW0iIHYtaWY9ImNhcmREYXRhLmJhc2ljX2luZm8uc29jaWFsX2xpbmtzLmRpc2NvcmQiIHNyYz0iaHR0cHM6Ly9zb3VsY2FyZC5ub25jZWdlZWsuY29tL3NvdWxjYXJkX2ljb24vZGlzY29yZC5zdmciIGFsdD0iIiAvPgogICAgICAgICAgICAgICAgPGltZyBAY2xpY2s9ImNvbnRjYXRDbGljayhmYWxzZSwgY2FyZERhdGEuYmFzaWNfaW5mby5zb2NpYWxfbGlua3MuZ2l0aHViX2xpbmspIiBjbGFzcz0icG9pbnRlciBjb250YWN0LWl0ZW0iIHYtaWY9ImNhcmREYXRhLmJhc2ljX2luZm8uc29jaWFsX2xpbmtzLmdpdGh1Yl9saW5rIiBzcmM9Imh0dHBzOi8vc291bGNhcmQubm9uY2VnZWVrLmNvbS9zb3VsY2FyZF9pY29uL2dpdGh1Yi5zdmciIGFsdD0iIiAvPgogICAgICAgICAgICAgICAgPGltZyBAY2xpY2s9ImNvbnRjYXRDbGljayhmYWxzZSwgY2FyZERhdGEuYmFzaWNfaW5mby5zb2NpYWxfbGlua3Mud2VjaGF0KSIgY2xhc3M9InBvaW50ZXIgY29udGFjdC1pdGVtIiB2LWlmPSJjYXJkRGF0YS5iYXNpY19pbmZvLnNvY2lhbF9saW5rcy53ZWNoYXQiIHNyYz0iaHR0cHM6Ly9zb3VsY2FyZC5ub25jZWdlZWsuY29tL3NvdWxjYXJkX2ljb24vd2VjaGF0LnN2ZyIgYWx0PSIiIC8+CiAgICAgICAgICAgICAgICA8aW1nIEBjbGljaz0iY29udGNhdENsaWNrKGZhbHNlLCBjYXJkRGF0YS5iYXNpY19pbmZvLnNvY2lhbF9saW5rcy50d2l0dGVyKSIgY2xhc3M9InBvaW50ZXIgY29udGFjdC1pdGVtIiB2LWlmPSJjYXJkRGF0YS5iYXNpY19pbmZvLnNvY2lhbF9saW5rcy50d2l0dGVyIiBzcmM9Imh0dHBzOi8vc291bGNhcmQubm9uY2VnZWVrLmNvbS9zb3VsY2FyZF9pY29uL3R3aXR0ZXIuc3ZnIiBhbHQ9IiIgLz4KICAgICAgICAgICAgICAgIDxpbWcgQGNsaWNrPSJjb250Y2F0Q2xpY2sodHJ1ZSwgY2FyZERhdGEuYmFzaWNfaW5mby5zb2NpYWxfbGlua3MubWlycm9yX2xpbmspIiBjbGFzcz0icG9pbnRlciBjb250YWN0LWl0ZW0iIHYtaWY9ImNhcmREYXRhLmJhc2ljX2luZm8uc29jaWFsX2xpbmtzLm1pcnJvcl9saW5rIiBzcmM9Imh0dHBzOi8vc291bGNhcmQubm9uY2VnZWVrLmNvbS9zb3VsY2FyZF9pY29uL21pcm8uc3ZnIiBhbHQ9IiIgLz4KICAgICAgICAgICAgICAgIDxpbWcgQGNsaWNrPSJjb250Y2F0Q2xpY2sodHJ1ZSwgY2FyZERhdGEuYmFzaWNfaW5mby5zb2NpYWxfbGlua3MudGVsZWdyYW0pIiBjbGFzcz0icG9pbnRlciBjb250YWN0LWl0ZW0iIHYtaWY9ImNhcmREYXRhLmJhc2ljX2luZm8uc29jaWFsX2xpbmtzLnRlbGVncmFtIiBzcmM9Imh0dHBzOi8vc291bGNhcmQubm9uY2VnZWVrLmNvbS9zb3VsY2FyZF9pY29uL3RlbGVncmFtLnN2ZyIgYWx0PSIiIC8+CiAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICA8ZGl2IGNsYXNzPSJhd3NvbWUtdGhpbmdzIGdlbmVyYWwtYm9yZGVyIG10LVs4cHhdIj4KICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJhd3NvbWUtdGhpbmdzLXRpdGxlIGZ0LXMtMTYgZnctNzAwIHRleHQtaWJtLWJvbGQiPgogICAgICAgICAgICAgICAgQXdlc29tZSBUaGluZ3MKICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICA8ZGl2IAogICAgICAgICAgICAgICAgY2xhc3M9ImJvcmRlci10IHAtOCBmdy03MDAgdGV4dC1pYm0gZnQtcy0xMiBmbGV4IiAKICAgICAgICAgICAgICAgIHYtZm9yPSIoaXRlbSwgaW5kZXgpIGluIGNhcmREYXRhLmF3ZXNvbWVfdGhpbmdzIgogICAgICAgICAgICAgICAgOmtleT0iaW5kZXgiPgogICAgICAgICAgICAgICAgPGRpdj57e2l0ZW0udGl0bGV9fTwvZGl2PgogICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iY2lyY2xlLWJ1dHRvbiBwb2ludGVyIj4KICAgICAgICAgICAgICAgICAgPGltZyBAY2xpY2s9Imp1bXBUbyhpdGVtLmxpbmspIiBzcmM9Imh0dHBzOi8vc291bGNhcmQubm9uY2VnZWVrLmNvbS9zb3VsY2FyZF9pY29uL3JpZ2h0LWNpcmNsZS1hcnJvdy5zdmciIGFsdD0iIiAvPgogICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICA8ZGl2IGNsYXNzPSJhd3NvbWUtdGhpbmdzIGdlbmVyYWwtYm9yZGVyIG10LVs4cHhdIHBiLVsyMHB4XSI+CiAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iYXdzb21lLXRoaW5ncy10aXRsZSBmdC1zLTE2IGZ3LTcwMCBib3JkZXItYiB0ZXh0LWlibS1ib2xkIj4KICAgICAgICAgICAgICAgIFByb2plY3QgQ29udHJpYnV0ZWQKICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSIiIHN0eWxlPSJwYWRkaW5nLWxlZnQ6IDhweCI+CiAgICAgICAgICAgICAgICA8ZGl2IAogICAgICAgICAgICAgICAgICAgIGNsYXNzPSJwcm9qZWN0LWl0ZW0gcG9pbnRlciBmdC1zLTEyIHRleHQtaWJtIiAKICAgICAgICAgICAgICAgICAgICB2LWZvcj0iKGl0ZW0sIGluZGV4KSBpbiBjYXJkRGF0YS5wcm9qZWN0X3doaXRlbGlzdCIKICAgICAgICAgICAgICAgICAgICBAY2xpY2s9Imp1bXBUbyhpdGVtLmxpbmspIgogICAgICAgICAgICAgICAgICAgIDprZXk9ImluZGV4Ij4KICAgICAgICAgICAgICAgICAgICB7e2l0ZW0udGl0bGV9fQogICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICA8ZGl2IGNsYXNzPSJhd3NvbWUtdGhpbmdzIGdlbmVyYWwtYm9yZGVyIG10LVs4cHhdIj4KICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJhd3NvbWUtdGhpbmdzLXRpdGxlIGZ0LXMtMTYgZnctNzAwIHRleHQtaWJtLWJvbGQiPgogICAgICAgICAgICAgICAgREFPL09yZ2FuaXphdGlvbgogICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImRhby1saXN0Ij4KICAgICAgICAgICAgICAgIDxkaXYgCiAgICAgICAgICAgICAgICAgICAgY2xhc3M9ImZsZXggYm9yZGVyLXQgZGFvLWl0ZW0iIAogICAgICAgICAgICAgICAgICAgIHYtZm9yPSIoaXRlbSwgaW5kZXgpIGluIGNhcmREYXRhLmRhb3Nfam9pbmVkIgogICAgICAgICAgICAgICAgICAgIDprZXk9ImluZGV4Ij4KICAgICAgICAgICAgICAgICAgICA8ZGl2PgogICAgICAgICAgICAgICAgICAgICAgPGltZwogICAgICAgICAgICAgICAgICAgICAgICA6c3JjPSJpdGVtLmF2YXRhciIKICAgICAgICAgICAgICAgICAgICAgICAgYWx0PSIiCiAgICAgICAgICAgICAgICAgICAgICAgIHN0eWxlPSJ3aWR0aDogNjFweDsgYm9yZGVyLXJhZGl1czogMTBweCIKICAgICAgICAgICAgICAgICAgICAgIC8+CiAgICAgICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iIiBzdHlsZT0ibWFyZ2luLWxlZnQ6IDE1cHg7Ij4KICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImRhby1uYW1lIGZ0LXMtMjQgZnQtNzAwIHRleHQtaWJtLWJvbGQiPgogICAgICAgICAgICAgICAgICAgICAgICB7e2l0ZW0ubmFtZX19CiAgICAgICAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImZsZXggcG9zaXRpb24gdGV4dC1pYm0iIHYtaWY9Iml0ZW0uaXNfY29yZV9tZW1iZXIiPgogICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJjLWljb24gZmxleCBtci1bOHB4XSI+CiAgICAgICAgICAgICAgICAgICAgICAgICAgPGltZyBzcmM9e2N9IGFsdD0iIiAvPgogICAgICAgICAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgICAgICAgICAgPHNwYW4+bWVtYmVyPC9zcGFuPgogICAgICAgICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgIDwvZGl2PgogICAgICAgICAgPGRpdiBpZD0iZGlzY29yZCI+e3tjYXJkRGF0YS5iYXNpY19pbmZvLnNvY2lhbF9saW5rcy5kaXNjb3JkfX08L2Rpdj4KICAgICAgICAgIDxkaXYgaWQ9ImdpdGh1Yl9saW5rIj57e2NhcmREYXRhLmJhc2ljX2luZm8uc29jaWFsX2xpbmtzLmdpdGh1Yl9saW5rfX08L2Rpdj4KICAgICAgICAgIDxkaXYgaWQ9InRlbGVncmFtIj57e2NhcmREYXRhLmJhc2ljX2luZm8uc29jaWFsX2xpbmtzLnRlbGVncmFtfX08L2Rpdj4KICAgICAgICAgIDxkaXYgaWQ9Im1pcnJvcl9saW5rIj57e2NhcmREYXRhLmJhc2ljX2luZm8uc29jaWFsX2xpbmtzLm1pcnJvcl9saW5rfX08L2Rpdj4KICAgICAgICAgIDxkaXYgaWQ9IndlY2hhdCI+e3tjYXJkRGF0YS5iYXNpY19pbmZvLnNvY2lhbF9saW5rcy53ZWNoYXR9fTwvZGl2PgogICAgICAgICAgPGRpdiBpZD0idHdpdHRlciI+e3tjYXJkRGF0YS5iYXNpY19pbmZvLnNvY2lhbF9saW5rcy50d2l0dGVyfX08L2Rpdj4KICAgIDwvZGl2PgogICAgPHNjcmlwdD4KICAgICAgICBjb25zdCB7IGNyZWF0ZUFwcCB9ID0gVnVlCiAgICAgICAgCiAgICAgICAgY3JlYXRlQXBwKHsKICAgICAgICAgIGRhdGEoKSB7CiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgbWVzc2FnZTogJ0hlbGxvIFZ1ZSEnLAogICAgICAgICAgICAgIGNhcmREYXRhOiB7CiAgICAgICAgICAgICAgICBhZGRyOiAie2FkZHJ9IiwKICAgICAgICAgICAgICAgIGJhc2ljX2luZm86IHsKICAgICAgICAgICAgICAgICAgICBuYW1lOiAne25hbWV9JywKICAgICAgICAgICAgICAgICAgICBhdmF0YXI6ICd7YXZhdGFyfScsCiAgICAgICAgICAgICAgICAgICAgZ2l0aHViOiB7CiAgICAgICAgICAgICAgICAgICAgICAgIGF2YXRhcjogJycsCiAgICAgICAgICAgICAgICAgICAgICAgIG5hbWU6ICcnLAogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgc2xvZ2FuOiAne3Nsb2dhbn0nLAogICAgICAgICAgICAgICAgICAgIHNvY2lhbF9saW5rczogewogICAgICAgICAgICAgICAgICAgICAgICB0ZWxlZ3JhbTogJ3t0ZWxlZ3JhbX0nLAogICAgICAgICAgICAgICAgICAgICAgICB0d2l0dGVyOiAne3R3aXR0ZXJ9JywKICAgICAgICAgICAgICAgICAgICAgICAgbWlycm9yX2xpbms6ICd7bWlycm9yX2xpbmt9JywKICAgICAgICAgICAgICAgICAgICAgICAgZ2l0aHViX2xpbms6ICd7Z2l0aHViX2xpbmt9JywKICAgICAgICAgICAgICAgICAgICAgICAgd2VjaGF0OiAne3dlY2hhdH0nLAogICAgICAgICAgICAgICAgICAgICAgICBkaXNjb3JkOiAne2Rpc2NvcmR9JywKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgIGxvY2F0aW9uOiAne2xvY2F0aW9ufScsCiAgICAgICAgICAgICAgICAgICAgc2tpbGxzOiB7c2tpbGxzfSwKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgIGF3ZXNvbWVfdGhpbmdzOiB7YXdlc29tZV90aGluZ3N9LAogICAgICAgICAgICAgICAgICAgIHByb2plY3Rfd2hpdGVsaXN0OiB7cHJvamVjdF93aGl0ZWxpc3R9LAogICAgICAgICAgICAgICAgICAgIGRhb3Nfam9pbmVkOiB7ZGFvc19qb2luZWR9LAogICAgICAgICAgICAgICAgICAgIG9yZ2FuaXphdGlvbjogW10KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0sCiAgICAgICAgICBtZXRob2RzOiB7CiAgICAgICAgICAgIGNvbnRjYXRDbGljayhuZWVkSnVtcCwgbGluaykgewogICAgICAgICAgICAgIHRoaXMuY29weUNvbnRlbnQobGluaykKICAgICAgICAgICAgICBpZiAobmVlZEp1bXApIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5vcGVuKGxpbmspCiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICBqdW1wVG8obGluaykgewogICAgICAgICAgICAgIHdpbmRvdy5vcGVuKGxpbmspCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGNvcHlDb250ZW50KHZhbHVlLCB0eXBlID0gJ2lucHV0JykgewogICAgICAgICAgICAgIGNvbnN0IGlucHV0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCh0eXBlKTsKICAgICAgICAgICAgICBpbnB1dC5zZXRBdHRyaWJ1dGUoJ3JlYWRvbmx5JywgJ3JlYWRvbmx5Jyk7IC8vIOiuvue9ruS4uuWPquivuywg6Ziy5q2i5ZyoIGlvcyDkuIvmi4notbfplK7nm5gKICAgICAgICAgICAgICAvLyBpbnB1dC5zZXRBdHRyaWJ1dGUoJ3ZhbHVlJywgdmFsdWUpOyAvLyB0ZXh0YXJlYSDkuI3og73nlKjmraTmlrnlvI/otYvlgLwsIOWQpuWImeaXoOazleWkjeWItuWGheWuuQogICAgICAgICAgICAgIGlucHV0LnZhbHVlID0gdmFsdWU7CiAgICAgICAgICAgICAgY29uc29sZS5sb2codmFsdWUpCiAgICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChpbnB1dCk7CiAgICAgICAgICAgICAgaW5wdXQuc2V0U2VsZWN0aW9uUmFuZ2UoMCwgOTk5OSk7IC8vIOmYsuatoiBpb3Mg5LiL5rKh5pyJ5YWo6YCJ5YaF5a656ICM5peg5rOV5aSN5Yi2CiAgICAgICAgICAgICAgaW5wdXQuc2VsZWN0KCk7CiAgICAgICAgICAgICAgZG9jdW1lbnQuZXhlY0NvbW1hbmQoJ2NvcHknKTsKICAgICAgICAgICAgICBkb2N1bWVudC5ib2R5LnJlbW92ZUNoaWxkKGlucHV0KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0pLm1vdW50KCcjYXBwJykKICAgICAgPC9zY3JpcHQ+CjwvYm9keT4KPC9odG1sPg=="]
    KVHandler.put("templates", templates, ModuleHandler.get_module_name(__MODULE__))
  end
end
